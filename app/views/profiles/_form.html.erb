<div id="profile_form">
  <%= form_with model: user, url: profile_path, method: :patch, multipart: true, data: { turbo: true } do |f| %>

    <!-- Email -->
    <div class="mb-3">
      <%= f.label :email, class: "form-label fw-semibold" %>
      <%= f.email_field :email, class: "form-control", placeholder: "Enter your email" %>
      <% user.errors.full_messages_for(:email).each do |msg| %>
        <div class="text-danger small"><%= msg %></div>
      <% end %>
    </div>

    <!-- Doctor -->
    <% if user.role == "doctor" %>
      <div class="border rounded-3 p-4 mb-4 bg-light">
        <h5 class="mb-3">Doctor Information</h5>
        <%= f.fields_for :doctor do |df| %>

          <div class="mb-3 text-center">
            <% if df.object.profile_picture.attached? %>
              <%= image_tag df.object.profile_picture.variant(resize_to_limit: [120, 120]), class: "rounded-circle mb-2" %>
            <% else %>
              <div class="rounded-circle bg-secondary mb-2" style="width: 120px; height: 120px;"></div>
            <% end %>
            <%= df.file_field :profile_picture, class: "form-control", accept: "image/*", onchange: "previewImage(event, 'doctor_preview')" %>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <%= df.label :first_name, class: "form-label" %>
              <%= df.text_field :first_name, class: "form-control", placeholder: "First Name" %>
              <% df.object.errors.full_messages_for(:first_name).each do |msg| %>
                <div class="text-danger small"><%= msg %></div>
              <% end %>
            </div>
            <div class="col-md-6 mb-3">
              <%= df.label :last_name, class: "form-label" %>
              <%= df.text_field :last_name, class: "form-control", placeholder: "Last Name" %>
            </div>
          </div>

          <div class="mb-3">
            <%= df.label :phone_number, class: "form-label" %>
            <%= df.telephone_field :phone_number, class: "form-control", placeholder: "+1 123 456 7890" %>
          </div>

          <div class="mb-3">
            <%= df.label :medical_specialty, class: "form-label" %>
            <%= df.text_field :medical_specialty, class: "form-control", placeholder: "e.g., Cardiology" %>
          </div>

          <div class="mb-3">
            <%= df.label :license_number, class: "form-label" %>
            <%= df.text_field :license_number, class: "form-control", placeholder: "e.g., MD12345" %>
          </div>

          <div class="mb-3">
            <%= df.label :npi_number, class: "form-label" %>
            <%= df.text_field :npi_number, class: "form-control", placeholder: "e.g., 1234567890" %>
          </div>

          <div class="mb-3">
            <%= df.label :professional_bio, class: "form-label" %>
            <%= df.text_area :professional_bio, class: "form-control", rows: 3, placeholder: "Write a brief bio..." %>
          </div>

        <% end %>
      </div>
    <% end %>

    <!-- Patient -->
    <% if user.role == "patient" %>
      <div class="border rounded-3 p-4 mb-4 bg-light">
        <h5 class="mb-3">Patient Information</h5>
        <%= f.fields_for :patient do |pf| %>

          <div class="mb-3 text-center">
            <% if pf.object.profile_picture.attached? %>
              <%= image_tag pf.object.profile_picture.variant(resize_to_limit: [120, 120]), class: "rounded-circle mb-2" %>
            <% else %>
              <div class="rounded-circle bg-secondary mb-2" style="width: 120px; height: 120px;"></div>
            <% end %>
            <%= pf.file_field :profile_picture, class: "form-control", accept: "image/*", onchange: "previewImage(event, 'patient_preview')" %>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <%= pf.label :first_name, class: "form-label" %>
              <%= pf.text_field :first_name, class: "form-control" %>
            </div>
            <div class="col-md-6 mb-3">
              <%= pf.label :last_name, class: "form-label" %>
              <%= pf.text_field :last_name, class: "form-control" %>
            </div>
          </div>

          <div class="mb-3">
            <%= pf.label :date_of_birth, "Date of Birth", class: "form-label" %>
            <%= pf.date_field :date_of_birth, class: "form-control" %>
          </div>

        <% end %>
      </div>
    <% end %>

    <div class="d-flex gap-2">
      <%= f.submit "Save Changes", class: "btn btn-primary" %>
      <%= link_to "â† Back", profile_path, class: "btn btn-outline-secondary" %>
    </div>

  <% end %>
</div>

<!-- JS for profile picture preview -->
<script>
  function previewImage(event, previewId) {
    const input = event.target;
    const reader = new FileReader();
    reader.onload = function(){
      let img = document.getElementById(previewId);
      if(!img){
        img = document.createElement('img');
        img.id = previewId;
        img.className = "rounded-circle mb-2";
        input.parentNode.insertBefore(img, input);
      }
      img.src = reader.result;
      img.style.width = "120px";
      img.style.height = "120px";
    };
    reader.readAsDataURL(input.files[0]);
  }
</script>
